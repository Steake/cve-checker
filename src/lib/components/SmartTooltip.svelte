<script>
    import { onMount, onDestroy } from 'svelte';

    /** @type {string} */
    export let content = '';
    /** @type {'top' | 'bottom'} */
    export let position = 'top';
    /** @type {'hover' | 'click'} */
    export let trigger = 'hover';
    /** @type {boolean} */
    export let mobileExpand = true;

    let tooltipEl;
    let wrapperEl;
    let visible = false;
    let computedPosition = position;
    let isMobile = false;

    const PADDING = 10; // Minimum padding from viewport edges

    function updatePosition() {
        if (!tooltipEl || !wrapperEl) return;

        const wrapperRect = wrapperEl.getBoundingClientRect();
        const tooltipRect = tooltipEl.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;

        // Reset position to allow full size calculation
        tooltipEl.style.left = '';
        tooltipEl.style.right = '';
        tooltipEl.style.top = '';
        tooltipEl.style.bottom = '';

        let left = wrapperRect.left;
        let top = wrapperRect.top - tooltipRect.height - 10;

        // Check if tooltip would overflow right edge
        if (left + tooltipRect.width > viewportWidth - PADDING) {
            left = Math.max(PADDING, viewportWidth - tooltipRect.width - PADDING);
        }

        // Check if tooltip would overflow left edge
        if (left < PADDING) {
            left = PADDING;
        }

        // Check if tooltip would overflow top edge
        if (top < PADDING) {
            // Position below the element
            top = wrapperRect.bottom + 10;
            computedPosition = 'bottom';
        } else {
            computedPosition = 'top';
        }

        // Check if tooltip would overflow bottom edge
        if (top + tooltipRect.height > viewportHeight - PADDING) {
            top = Math.max(PADDING, viewportHeight - tooltipRect.height - PADDING);
        }

        tooltipEl.style.left = `${left}px`;
        tooltipEl.style.top = `${top}px`;
    }

    function checkMobile() {
        isMobile = window.matchMedia('(max-width: 768px)').matches;
    }

    function handleClick(event) {
        if (trigger === 'click' || isMobile) {
            event.stopPropagation();
            visible = !visible;
            if (visible) {
                setTimeout(updatePosition, 0);
            }
        }
    }

    function handleKeyDown(event) {
        if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            handleClick(event);
        } else if (event.key === 'Escape' && visible) {
            visible = false;
        }
    }

    function handleMouseEnter() {
        if (trigger === 'hover' && !isMobile) {
            visible = true;
            setTimeout(updatePosition, 0);
        }
    }

    function handleMouseLeave() {
        if (trigger === 'hover' && !isMobile) {
            visible = false;
        }
    }

    function handleClickOutside(event) {
        if (visible && wrapperEl && !wrapperEl.contains(event.target)) {
            visible = false;
        }
    }

    onMount(() => {
        checkMobile();
        window.addEventListener('resize', updatePosition);
        window.addEventListener('scroll', updatePosition);
        window.addEventListener('resize', checkMobile);
        document.addEventListener('click', handleClickOutside);
    });

    onDestroy(() => {
        window.removeEventListener('resize', updatePosition);
        window.removeEventListener('scroll', updatePosition);
        window.removeEventListener('resize', checkMobile);
        document.removeEventListener('click', handleClickOutside);
    });
</script>

<div 
    class="tooltip-wrapper"
    bind:this={wrapperEl}
    on:click={handleClick}
    on:keydown={handleKeyDown}
    on:mouseenter={handleMouseEnter}
    on:mouseleave={handleMouseLeave}
    role="button"
    tabindex="0"
    aria-expanded={visible}
>
    <slot />
    
    {#if visible}
        <div
            class="tooltip"
            class:mobile={isMobile}
            data-position={computedPosition}
            bind:this={tooltipEl}
            role="tooltip"
            aria-hidden={!visible}
        >
            {#if typeof content === 'string'}
                {@html content.split('\n').join('<br>')}
            {:else}
                {content}
            {/if}
            <div class="tooltip-arrow" data-position={computedPosition} />
        </div>
    {/if}

    {#if isMobile && mobileExpand && visible}
        <div 
            class="mobile-content" 
            role="tooltip"
            aria-hidden={!visible}
        >
            {#if typeof content === 'string'}
                {@html content.split('\n').join('<br>')}
            {:else}
                {content}
            {/if}
        </div>
    {/if}
</div>

<style>
    .tooltip-wrapper {
        position: relative;
        display: inline-block;
        cursor: pointer;
    }

    .tooltip {
        position: fixed;
        z-index: 1000;
        background: var(--color-bg-1);
        border: 1px solid var(--color-theme-2);
        border-radius: 4px;
        padding: 1rem;
        font-size: 0.9rem;
        line-height: 1.4;
        color: var(--color-text);
        max-width: 400px;
        min-width: 200px;
        box-shadow: 0 2px 10px rgba(0, 255, 0, 0.1);
        pointer-events: none;
        text-align: left;
        white-space: pre-wrap;
        word-break: break-word;
    }

    .tooltip-arrow {
        position: absolute;
        width: 12px;
        height: 12px;
        background: var(--color-bg-1);
        border: 1px solid var(--color-theme-2);
        transform: rotate(45deg);
        pointer-events: none;
    }

    .tooltip-arrow[data-position="top"] {
        bottom: -7px;
        left: 50%;
        margin-left: -6px;
        border-top: none;
        border-left: none;
    }

    .tooltip-arrow[data-position="bottom"] {
        top: -7px;
        left: 50%;
        margin-left: -6px;
        border-bottom: none;
        border-right: none;
    }

    .mobile-content {
        display: none;
    }

    @media (max-width: 768px) {
        .tooltip {
            display: none;
        }

        .mobile-content {
            display: block;
            background: var(--color-bg-1);
            border: 1px solid var(--color-theme-2);
            border-radius: 4px;
            padding: 1rem;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            line-height: 1.4;
            color: var(--color-text);
            width: 100%;
            box-sizing: border-box;
            text-align: left;
            white-space: pre-wrap;
            word-break: break-word;
        }
    }

    /* Focus styles */
    .tooltip-wrapper:focus {
        outline: 2px solid var(--color-theme-1);
        outline-offset: 2px;
    }

    .tooltip-wrapper:focus:not(:focus-visible) {
        outline: none;
    }

    /* High contrast mode */
    @media (forced-colors: active) {
        .tooltip,
        .mobile-content {
            border: 2px solid ButtonText;
        }
        
        .tooltip-arrow {
            background: ButtonText;
            border-color: ButtonText;
        }
    }
</style>