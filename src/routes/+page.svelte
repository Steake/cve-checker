<script>
	import { format } from 'date-fns';
	import Fuse from 'fuse.js';
	import PocItem from './PocItem.svelte';
	import Filters from './Filters.svelte';
	import { filterByDate } from '$lib/utils';

	/** @type {import('./$types').PageData} */
	export let data;

	let sortBy = 'updated';
	let sources = ['github', 'gitlab'];
	let maxStars = 0;
	let dateFilter = 'all';
	let searchQuery = '';

	// Initialize Fuse.js for fuzzy search
	const fuseOptions = {
		keys: ['title', 'description'],
		threshold: 0.4,
		includeScore: true
	};
	$: fuse = new Fuse(data.pocs, fuseOptions);

	$: filteredPocs = searchQuery
		? fuse.search(searchQuery).map(result => result.item)
		: data.pocs;

	$: displayedPocs = filteredPocs
		.filter(poc => sources.includes(poc.source))
		.filter(poc => maxStars === 0 || poc.stars <= maxStars)
		.filter(poc => filterByDate(poc.created, dateFilter))
		.sort((a, b) => {
			if (sortBy === 'stars') return b.stars - a.stars;
			if (sortBy === 'created') return new Date(b.created) - new Date(a.created);
			return new Date(b.updated) - new Date(a.updated);
		});

	function handleFilter(event) {
		({ sortBy, sources, maxStars, dateFilter } = event.detail);
	}
</script>

<svelte:head>
	<title>CVE PoC Tracker</title>
	<meta name="description" content="Track the latest CVE Proof of Concepts from GitHub and GitLab" />
</svelte:head>

<section>
	<h1>Latest CVE PoCs</h1>
	<div class="container">
		<div class="search-container">
			<input
				type="text"
				bind:value={searchQuery}
				placeholder="Search by title or description..."
				class="search-input"
			/>
		</div>
		<Filters {sortBy} {sources} {maxStars} {dateFilter} on:filter={handleFilter} />
		<div class="poc-list">
			{#if displayedPocs.length === 0}
				<div class="empty-state">
					<p>No PoCs found matching your criteria</p>
				</div>
			{:else}
				{#each displayedPocs as poc}
					<PocItem {poc} />
				{/each}
			{/if}
		</div>
	</div>
</section>

<style>
	section {
		width: 100%;
		max-width: 800px;
		margin: 0 auto;
		padding: 0 1rem;
	}

	.container {
		width: 100%;
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}

	h1 {
		color: var(--color-theme-1);
		margin-bottom: 2rem;
	}

	.search-container {
		width: 100%;
	}

	.search-input {
		width: 100%;
		padding: 0.75rem;
		background: var(--color-bg-2);
		border: 1px solid var(--color-theme-2);
		border-radius: 4px;
		color: var(--color-text);
		font-family: var(--font-mono);
		box-sizing: border-box;
	}

	.search-input:focus {
		outline: none;
		border-color: var(--color-theme-1);
		box-shadow: 0 0 5px rgba(0, 255, 0, 0.2);
	}

	.search-input::placeholder {
		color: var(--color-text-dim);
		opacity: 0.6;
	}

	.poc-list {
		display: flex;
		flex-direction: column;
		gap: 1rem;
		width: 100%;
	}

	.empty-state {
		text-align: center;
		padding: 2rem;
		background: var(--color-bg-2);
		border-radius: 4px;
		border: 1px solid var(--color-theme-2);
		width: 100%;
		box-sizing: border-box;
	}

	.empty-state p {
		color: var(--color-text-dim);
		margin: 0;
	}
</style>