<script>
    import { onMount } from 'svelte';
    import { getTimeAgo } from '$lib/utils';
    import { fetchCveDetails } from '$lib/services/cveService';
    import { getSeverityInfo } from '$lib/utils/severity';
    import { extractCveId } from '$lib/utils/cveUtils';
    import { formatCveTooltip } from '$lib/utils/tooltipFormatter';
    import SmartTooltip from '$lib/components/SmartTooltip.svelte';
    
    /** @type {{ 
        title: string;
        description: string;
        url: string;
        author: string;
        stars: number;
        created: string;
        updated: string;
        source: 'github' | 'gitlab';
    }} */
    export let poc;

    /** @type {any} */
    let cveDetails = null;
    let loading = true;
    let error = null;

    $: timeAgo = getTimeAgo(poc.updated);
    $: cveId = extractCveId(poc.title) || extractCveId(poc.description || '');
    $: severity = cveDetails?.cvss || 0;
    $: severityInfo = getSeverityInfo(severity);
    $: tooltipContent = formatCveTooltip(cveDetails);

    onMount(async () => {
        if (cveId) {
            try {
                loading = true;
                cveDetails = await fetchCveDetails(cveId);
            } catch (e) {
                error = e;
                console.error(`Error fetching CVE ${cveId}:`, e);
            } finally {
                loading = false;
            }
        } else {
            loading = false;
        }
    });
</script>

<div class="poc-item">
    <div class="title-row">
        <div class="title-content">
            <span class="source-icon" title="Source: {poc.source}">
                {#if poc.source === 'github'}
                    <svg viewBox="0 0 16 16" width="16" height="16">
                        <path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                    </svg>
                {:else}
                    <svg viewBox="0 0 16 16" width="16" height="16">
                        <path fill="currentColor" d="M15.97 9.058l-.975-3.002L11.89.562a.453.453 0 0 0-.862 0L7.923 6.056H2.077L-.03 9.058a.454.454 0 0 0 .148.496l6.857 5.003V8.163h1.949v6.394l6.857-5.003a.453.453 0 0 0 .148-.496z"/>
                    </svg>
                {/if}
            </span>
            <a href={poc.url} target="_blank" rel="noopener noreferrer">
                <h2>{poc.title}</h2>
            </a>
        </div>
        <span class="stars">⭐ {poc.stars}</span>
    </div>
    
    {#if cveId}
        <div class="cve-info">
            <SmartTooltip content={tooltipContent} trigger="click">
                <span class="cve-id">
                    {cveId}
                    {#if loading}
                        <span class="loading-indicator">...</span>
                    {:else if error}
                        <span class="error-indicator">!</span>
                    {/if}
                </span>
            </SmartTooltip>
            
            {#if !loading && !error && cveDetails?.cvss}
                <div 
                    class="severity-badge"
                    style="--severity-color: {severityInfo.color}"
                >
                    {severityInfo.label} ({severity.toFixed(1)})
                </div>
            {/if}
        </div>
    {/if}

    {#if poc.description}
        <p class="description">{poc.description}</p>
    {/if}
    
    <div class="meta">
        <span>by {poc.author}</span>
        <span>•</span>
        <span title="Last updated: {new Date(poc.updated).toLocaleString()}">{timeAgo}</span>
    </div>
</div>

<style>
    .poc-item {
        background: var(--color-bg-2);
        padding: 1rem;
        border-radius: 4px;
        box-shadow: 0 0 10px rgba(0, 255, 0, 0.1);
        border: 1px solid var(--color-theme-2);
        margin-bottom: 1rem;
        position: relative;
    }

    .title-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .title-content {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .source-icon {
        color: var(--color-text-dim);
        display: flex;
        align-items: center;
    }

    h2 {
        margin: 0;
        font-size: 1.2rem;
        color: var(--color-theme-1);
    }

    .stars {
        font-size: 0.9rem;
        color: var(--color-text-dim);
    }

    .cve-info {
        display: flex;
        gap: 1rem;
        margin: 0.5rem 0;
        align-items: center;
        flex-wrap: wrap;
    }

    .cve-id {
        background: var(--color-bg-1);
        color: var(--color-theme-1);
        padding: 0.2rem 0.5rem;
        border-radius: 3px;
        font-size: 0.9rem;
        border: 1px solid var(--color-theme-2);
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .loading-indicator {
        opacity: 0.7;
        animation: pulse 1.5s infinite;
    }

    .error-indicator {
        color: #ff4400;
        font-weight: bold;
    }

    .severity-badge {
        background: color-mix(in srgb, var(--severity-color) 15%, transparent);
        color: var(--severity-color);
        padding: 0.2rem 0.5rem;
        border-radius: 3px;
        font-size: 0.9rem;
        border: 1px solid var(--severity-color);
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .description {
        margin: 0.5rem 0;
        color: var(--color-text-dim);
        font-size: 0.95rem;
    }

    .meta {
        margin-top: 0.5rem;
        font-size: 0.8rem;
        color: var(--color-text-dim);
        display: flex;
        gap: 0.5rem;
        opacity: 0.8;
    }

    a {
        text-decoration: none;
    }

    a:hover h2 {
        text-decoration: underline;
        color: var(--color-theme-2);
    }

    @keyframes pulse {
        0%, 100% { opacity: 0.3; }
        50% { opacity: 0.7; }
    }

    @media (max-width: 480px) {
        .title-row {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .stars {
            margin-left: 1.5rem;
        }
    }
</style>